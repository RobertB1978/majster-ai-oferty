name: Supabase Deploy Autopilot

# ‚ö° Uruchamianie: WY≈ÅƒÑCZNIE RƒòCZNIE przez GitHub Actions UI
# Cel: Deploy migracji DB + Edge Functions do Supabase (zero rƒôcznych krok√≥w)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (production only for now)'
        required: false
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy-supabase:
    name: Deploy Migrations & Functions
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

    steps:
      # ========================================
      # 1. CHECKOUT REPO
      # ========================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2. INSTALL SUPABASE CLI
      # ========================================
      - name: üîß Install Supabase CLI
        run: |
          # Remove old binary if exists (idempotent install) without touching repo's supabase/ folder
          sudo rm -f /usr/local/bin/supabase || true
          TMP_CLI_DIR=$(mktemp -d)
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz -C "$TMP_CLI_DIR"
          sudo mv "$TMP_CLI_DIR/supabase" /usr/local/bin/
          rm -rf "$TMP_CLI_DIR"
          supabase --version

      # ========================================
      # 3. LOGIN TO SUPABASE
      # ========================================
      - name: üîê Login to Supabase
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå ERROR: SUPABASE_ACCESS_TOKEN is not set!"
            echo "üëâ Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          echo "‚úÖ SUPABASE_ACCESS_TOKEN found (${#SUPABASE_ACCESS_TOKEN} chars)"
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      # ========================================
      # 4. VALIDATE PROJECT REF MATCH
      # ========================================
      - name: üîç Validate project ref matches config.toml
        run: |
          # Read project_id from config.toml (source of truth)
          if [ ! -f "supabase/config.toml" ]; then
            echo "‚ùå ERROR: supabase/config.toml not found!"
            exit 1
          fi

          CONFIG_PROJECT_ID=$(grep 'project_id' supabase/config.toml | cut -d '"' -f 2)
          echo "üìã config.toml project_id: $CONFIG_PROJECT_ID"

          # Check if SUPABASE_PROJECT_REF secret is set
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "‚ö†Ô∏è WARNING: SUPABASE_PROJECT_REF secret not set!"
            echo "üìù Using project_id from config.toml: $CONFIG_PROJECT_ID"
            echo "üí° TIP: Set SUPABASE_PROJECT_REF in GitHub Secrets for validation"
          else
            echo "üîê GitHub Secret SUPABASE_PROJECT_REF: $SUPABASE_PROJECT_REF"

            # Validate match
            if [ "$CONFIG_PROJECT_ID" != "$SUPABASE_PROJECT_REF" ]; then
              echo ""
              echo "‚ùå ERROR: Project ref mismatch detected!"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "config.toml:          $CONFIG_PROJECT_ID"
              echo "SUPABASE_PROJECT_REF: $SUPABASE_PROJECT_REF"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "üõ†Ô∏è HOW TO FIX:"
              echo "1. Check which project ref is correct (production Supabase project)"
              echo "2. Update supabase/config.toml OR GitHub Secret to match"
              echo "3. See docs/SINGLE_SOURCE_OF_TRUTH.md for details"
              echo ""
              exit 1
            fi

            echo "‚úÖ Project ref validation passed: $CONFIG_PROJECT_ID"
          fi

      # ========================================
      # 5. LINK TO PROJECT
      # ========================================
      - name: üîó Link to Supabase project
        run: |
          # Use project_id from config.toml (validated in previous step)
          PROJECT_REF=$(grep 'project_id' supabase/config.toml | cut -d '"' -f 2)
          echo "üîó Linking to project: $PROJECT_REF"
          supabase link --project-ref "$PROJECT_REF"

      # ========================================
      # 6. PUSH DATABASE MIGRATIONS
      # ========================================
      - name: üì§ Push database migrations
        run: |
          echo "üìä Checking for migrations..."
          if [ ! -d "supabase/migrations" ]; then
            echo "‚ö†Ô∏è No migrations folder found, skipping DB push"
            exit 0
          fi

          MIGRATION_COUNT=$(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)
          echo "üìÅ Found $MIGRATION_COUNT migration file(s)"

          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No migration files found, skipping DB push"
            exit 0
          fi

          echo "üöÄ Pushing migrations to Supabase..."
          supabase db push
          echo "‚úÖ Database migrations applied successfully"

      # ========================================
      # 7. DEPLOY EDGE FUNCTIONS
      # ========================================
      - name: üöÄ Deploy Edge Functions
        run: |
          echo "üìä Checking for Edge Functions..."
          if [ ! -d "supabase/functions" ]; then
            echo "‚ö†Ô∏è No functions folder found, skipping functions deploy"
            exit 0
          fi

          FUNCTION_COUNT=$(find supabase/functions -maxdepth 1 -mindepth 1 -type d | wc -l)
          echo "üìÅ Found $FUNCTION_COUNT function folder(s)"

          if [ "$FUNCTION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No function folders found, skipping functions deploy"
            exit 0
          fi

          echo "üöÄ Deploying all Edge Functions..."

          # Deploy wszystkie funkcje (zachowujƒÖc ustawienia verify_jwt z config.toml)
          for func_dir in supabase/functions/*/; do
            func_name=$(basename "$func_dir")

            # Pomi≈Ñ folder _shared (wsp√≥lne utilities)
            if [ "$func_name" = "_shared" ]; then
              echo "‚è≠Ô∏è Skipping _shared folder"
              continue
            fi

            # Sprawd≈∫ czy funkcja ma plik index.ts
            if [ ! -f "$func_dir/index.ts" ]; then
              echo "‚ö†Ô∏è Skipping $func_name (no index.ts found)"
              continue
            fi

            echo "üì¶ Deploying: $func_name..."

            # Deploy funkcji (Supabase CLI automatycznie odczyta verify_jwt z config.toml)
            if supabase functions deploy "$func_name"; then
              echo "  ‚úÖ $func_name deployed successfully"
            else
              echo "  ‚ùå $func_name deployment failed"
              exit 1
            fi
          done

          echo "‚úÖ All Edge Functions deployed successfully"

      # ========================================
      # 8. VERIFY DEPLOYMENT
      # ========================================
      - name: ‚úÖ Verify deployment
        run: |
          echo "üîç Verifying deployment..."

          # Lista kluczowych tabel (top 10)
          CRITICAL_TABLES=(
            "profiles"
            "organizations"
            "clients"
            "projects"
            "quotes"
            "offer_sends"
            "offer_approvals"
            "user_subscriptions"
            "notifications"
            "team_members"
          )

          echo "üìä Checking critical tables..."
          MISSING_TABLES=()

          for table in "${CRITICAL_TABLES[@]}"; do
            # Sprawd≈∫ istnienie tabeli przez Supabase CLI
            if supabase db remote list | grep -q "public.$table"; then
              echo "  ‚úÖ Table exists: $table"
            else
              echo "  ‚ùå Table MISSING: $table"
              MISSING_TABLES+=("$table")
            fi
          done

          if [ ${#MISSING_TABLES[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå VERIFICATION FAILED: ${#MISSING_TABLES[@]} critical table(s) missing:"
            printf '   - %s\n' "${MISSING_TABLES[@]}"
            echo ""
            echo "üëâ This usually means migrations didn't run properly."
            echo "üëâ Check previous step logs for errors."
            exit 1
          fi

          echo ""
          echo "üéâ VERIFICATION PASSED!"
          echo "‚úÖ All critical tables exist"
          echo "‚úÖ Migrations applied successfully"
          echo "‚úÖ Edge Functions deployed"

      # ========================================
      # 9. DEPLOYMENT SUMMARY
      # ========================================
      - name: üìã Deployment summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "   SUPABASE DEPLOYMENT SUMMARY"
          echo "========================================="
          echo ""
          echo "Project: ${SUPABASE_PROJECT_REF:-[from config.toml]}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Deployed components:"
          echo "  üìä Database Migrations: ‚úÖ"
          echo "  üöÄ Edge Functions: ‚úÖ"
          echo "  üîç Verification: ‚úÖ"
          echo ""
          echo "========================================="
          echo ""
          echo "üéâ Deployment completed successfully!"
          echo ""
          echo "Next steps:"
          echo "  1. Verify in Supabase Dashboard:"
          echo "     - Table Editor: Check if tables exist"
          echo "     - Edge Functions: Check if functions deployed"
          echo "  2. Test your app (localhost or Vercel)"
          echo ""
          echo "========================================="
