name: i18n Quality Gate

# Runs on every PR and every push to main/develop.
# Blocks merge if any i18n invariant is violated.

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  i18n:
    name: i18n Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5

      # ── 1. Key Parity Gate ────────────────────────────────────────────────
      # PL / EN / UK must have an identical set of translation keys.
      # --fail-on-empty is omitted here so that placeholder "" values are only
      # reported as warnings on feature branches. Enable --fail-on-empty on
      # release branches by adding a branch condition or a separate job.
      - name: Check key parity (PL / EN / UK)
        run: node scripts/i18n/check-parity.mjs

      # ── 2a. Hardcoded Strings — full audit (report-only) ─────────────────
      # Shows total count across the codebase. continue-on-error: true so
      # pre-existing legacy violations do not block the whole PR. Used for
      # trend monitoring only.
      - name: Report hardcoded Polish strings (full audit)
        run: bash scripts/check-i18n-hardcodes.sh
        continue-on-error: true

      # ── 2b. Hardcoded Strings — PR-01 GATE (blocks merge) ─────────────────
      # PR-01 Tooling Fundamentals: this step is the enforcing gate.
      # It checks ONLY the files changed in this PR vs the merge base.
      # Any newly-introduced Polish diacritic in a component/page/hook causes
      # an immediate failure — even before ESLint. Legacy files are unaffected.
      # See scripts/i18n/gate-pr-changes.sh for logic.
      - name: i18n Gate — block new hardcoded strings in changed files
        run: |
          # Fetch base branch so git diff has the reference
          git fetch origin ${{ github.base_ref || 'main' }} --depth=1 2>/dev/null || true
          bash scripts/i18n/gate-pr-changes.sh "origin/${{ github.base_ref || 'main' }}"

      # ── 3. ESLint i18n Rules ──────────────────────────────────────────────
      # Runs the full ESLint suite (includes i18next/no-literal-string).
      # Errors fail the job; warnings are informational.
      - name: ESLint (includes i18n/no-literal-string)
        run: npm run lint
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}

      # ── 4. i18n Unit Tests ────────────────────────────────────────────────
      # Vitest suite includes src/test/i18n/locale-completeness.test.ts which
      # verifies runtime key parity, critical key presence and language switching.
      - name: i18n unit tests
        run: npx vitest run src/test/i18n/
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}

      # ── 5. TypeScript type-check ──────────────────────────────────────────
      # Ensures typed i18n augmentation (src/@types/i18next.d.ts) compiles
      # and that t() calls use valid keys from pl.json.
      - name: TypeScript type-check
        run: npm run type-check
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}
