# Offer PDF Specification — Majster.AI

**Version:** Δ3 (2026-02-23)
**Scope:** jsPDF code path (`src/lib/offerPdfGenerator.ts`) and browser-print path (`src/pages/PdfGenerator.tsx`)

---

## Required Fields (Compliance Minimum)

Every generated offer PDF **MUST** contain the following three sections. Absence of any field is a compliance failure.

### 1. Document ID

| Field | Source | Format | Example |
|-------|--------|--------|---------|
| `documentId` | Computed from `projectId` | `OF/{year}/{6-char-prefix}` | `OF/2026/A1B2C3` |

- Generated by `generateDocumentId(projectId, date?)` in `src/lib/offerDataBuilder.ts`
- Derived from the first 6 alphanumeric characters of the project UUID, uppercased
- Stable: the same `projectId` always produces the same ID for a given year
- Displayed as: **Nr: OF/2026/A1B2C3** in the PDF header

**Failure behavior:** If `projectId` is missing or empty, `generateDocumentId` falls back to `OF/{year}/UNKNWN`.

---

### 2. Dates

| Field | Source | Format | Example |
|-------|--------|--------|---------|
| `issuedAt` | `new Date()` at generation time | `dd.mm.yyyy` (pl-PL locale) | `15.01.2026` |
| `validUntil` | `issuedAt + 30 days` (default) | `dd.mm.yyyy` (pl-PL locale) | `14.02.2026` |

- `issuedAt` is set when `buildOfferData()` is called (i.e. when the PDF generation starts)
- `validUntil` defaults to 30 calendar days after `issuedAt`; can be overridden via `buildOfferData({ validUntil: ... })`
- Displayed as:
  - **Data wystawienia: 15.01.2026**
  - **Ważna do: 14.02.2026**

**Failure behavior:** Both dates are always computed — they cannot be null or undefined.

---

### 3. VAT Handling

Two mutually exclusive display modes:

#### Mode A — VAT-Exempt Seller (default)

Shown when `QuoteData.isVatExempt === true` (i.e. `vatRate === null`).

```
Sprzedawca zwolniony z podatku VAT (art. 43 ust. 1 ustawy o VAT)
```

This is the default for all offers. Most Polish construction micro-businesses and sole traders are exempt from VAT under article 43.1 of the Polish VAT Act.

#### Mode B — VAT Payer

Shown when `QuoteData.vatRate` is a non-null number (e.g. `23`).

```
Wartość netto:   1 000,00 zł
VAT (23%):         230,00 zł
Wartość brutto:  1 230,00 zł
```

**Fields:**

| Field | Meaning |
|-------|---------|
| `vatRate` | VAT rate percentage (e.g. `23`) |
| `netTotal` | Base amount before VAT (equals `total` in the current model) |
| `vatAmount` | `netTotal × (vatRate / 100)` |
| `grossTotal` | `netTotal + vatAmount` |

**Failure behavior:** If `vatRate` is undefined, it is treated as `null` (VAT-exempt). No null values are ever rendered in the PDF.

---

## Data Model

```typescript
// src/lib/offerDataBuilder.ts

interface QuoteData {
  total: number;
  vatRate: number | null;   // null = VAT-exempt
  isVatExempt: boolean;
  netTotal: number;
  vatAmount: number;
  grossTotal: number;
  // ...positions, summaryMaterials, summaryLabor, marginPercent
}

interface OfferPdfPayload {
  documentId: string;   // "OF/2026/A1B2C3"
  issuedAt: Date;
  validUntil: Date;
  quote: QuoteData | null;
  // ...company, client, pdfConfig, generatedAt, projectId, projectName
}
```

---

## PDF Generation Code Paths

| Path | File | VAT | Dates | Doc ID |
|------|------|-----|-------|--------|
| jsPDF (primary) | `src/lib/offerPdfGenerator.ts` | ✅ | ✅ | ✅ |
| Browser print | `src/pages/PdfGenerator.tsx` | ✅ (exempt only) | ✅ | ✅ |
| HTML preview | `src/components/offers/PdfPreviewPanel.tsx` | — | partial | — |

> The HTML preview in `PdfPreviewPanel.tsx` is a visual draft only. The actual PDF is generated by the jsPDF path.

---

## Generating a Compliant Offer

```typescript
import { buildOfferData } from '@/lib/offerDataBuilder';
import { generateOfferPdf } from '@/lib/offerPdfGenerator';

// Minimum viable: all compliance fields auto-computed
const payload = buildOfferData({
  projectId: 'abc123',
  projectName: 'Remont łazienki',
});

// With explicit VAT rate (23%)
const payloadWithVat = buildOfferData({
  projectId: 'abc123',
  projectName: 'Remont łazienki',
  quote: {
    positions: [...],
    summary_materials: 500,
    summary_labor: 800,
    margin_percent: 20,
    total: 1560,
    vat_rate: 23,     // add this to enable VAT breakdown
  },
});

const blob = await generateOfferPdf(payloadWithVat);
```

---

## Testing

Compliance assertions are in `src/lib/offerPdfGenerator.test.ts`, `describe('PDF compliance fields (Δ3)')`:

1. Document ID present in PDF text
2. `Data wystawienia:` label present
3. `Ważna do:` label present
4. VAT exempt notice (`zwolniony.*VAT`) when `isVatExempt: true`
5. `Wartość netto:` / `VAT (n%):` / `Wartość brutto:` when `vatRate` is set

Run: `npm test -- offerPdfGenerator`
